<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0d1117">
  <title>WPSD Quick Admin</title>
  <style>
    /* 8px grid, WCAG touch targets (44px), mobile-first */
    :root {
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --touch: 44px;
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      --font-mono: ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, monospace;
      --bg: #0d1117;
      --bg-elevated: #161b22;
      --bg-card: #21262d;
      --border: rgba(255,255,255,.12);
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --success-bg: rgba(63,185,80,.15);
      --danger: #f85149;
      --danger-bg: rgba(248,81,73,.15);
      --warning: #d29922;
      --transition: 0.15s ease;
    }
    @media (prefers-reduced-motion: reduce) { :root { --transition: 0s; } }

    *, *::before, *::after { box-sizing: border-box; }
    html { font-size: 16px; -webkit-text-size-adjust: 100%; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: var(--space-md);
      min-height: 100vh;
      line-height: 1.5;
    }
    @media (min-width: 640px) { body { padding: var(--space-xl); } }

    .app-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--border);
    }
    .app-title {
      font-size: 1.375rem;
      font-weight: 600;
      margin: 0;
      color: var(--accent);
      letter-spacing: -0.02em;
    }
    .app-subtitle {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin: 2px 0 0;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    @media (min-width: 640px) {
      .card { margin-bottom: var(--space-lg); }
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border);
    }
    .card-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 var(--space-sm);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border);
    }
    .card-desc {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin: 0 0 var(--space-md);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      align-items: center;
    }
    .row + .row { margin-top: var(--space-sm); }
    .row:last-child { margin-bottom: 0; }

    button, .btn {
      min-height: var(--touch);
      min-width: var(--touch);
      padding: var(--space-sm) var(--space-md);
      font-size: 0.9375rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      transition: background var(--transition), transform var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    button:hover:not(:disabled), .btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }
    button:active:not(:disabled), .btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    button:focus-visible, .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-success { background: var(--success); }
    .btn-success:hover:not(:disabled) { background: #46c35a; }
    .btn-danger { background: var(--danger); }
    .btn-danger:hover:not(:disabled) { background: #ff6b6b; }

    input[type="text"], input[type="number"] {
      min-height: var(--touch);
      padding: 0 var(--space-md);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.9375rem;
      width: 80px;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88,166,255,.2);
    }
    input::placeholder { color: var(--text-muted); opacity: 0.8; }
    #wpsdHost { width: 100%; max-width: 280px; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      border-radius: 999px;
      font-size: 0.8125rem;
      font-weight: 500;
    }
    .status-pill::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    .status-pill.ok { color: var(--success); background: var(--success-bg); }
    .status-pill.err { color: var(--danger); background: var(--danger-bg); }
    .tg-status {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-md);
      margin-bottom: var(--space-md);
      font-size: 0.9375rem;
    }
    .tg-status span {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-weight: 500;
    }

    .segmented {
      display: inline-flex;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: var(--space-xs);
      gap: var(--space-xs);
    }
    .segmented label {
      min-height: var(--touch);
      padding: 0 var(--space-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: background var(--transition), color var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    .segmented input { display: none; }
    .segmented input:checked + label {
      background: var(--accent);
      color: #fff;
    }

    .grid {
      display: grid;
      gap: var(--space-sm);
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    .danger-zone {
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid var(--border);
    }

    .msg {
      font-size: 0.875rem;
      margin-top: var(--space-sm);
      color: var(--text-muted);
    }
    .msg.ok { color: var(--success); }
    .msg.err { color: var(--danger); }

    .table-wrap {
      overflow-x: auto;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      margin-bottom: var(--space-md);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th {
      text-align: left;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      color: var(--text-muted);
      font-weight: 600;
      white-space: nowrap;
    }
    td {
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border);
    }
    tr:hover td { background: rgba(255,255,255,.03); }
    td { font-family: var(--font-mono); font-size: 0.8125rem; }
    td:first-child { color: var(--text-muted); }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: var(--space-md);
    }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      max-width: 360px;
      width: 100%;
      text-align: center;
    }
    .modal p { margin: 0 0 var(--space-lg); font-size: 1rem; line-height: 1.5; }
    .modal .btns { display: flex; gap: var(--space-sm); justify-content: center; flex-wrap: wrap; }
    .modal .btns button { flex: 1; min-width: 100px; }
  </style>
</head>
<body>
  <header class="app-header">
    <div>
      <h1 class="app-title">WPSD Quick Admin</h1>
      <p class="app-subtitle">TGIF and hotspot control</p>
    </div>
  </header>

  <section class="card">
    <h2 class="card-title">Settings</h2>
    <p class="card-desc">Update the hotspot IP when switching networks (e.g., mobile hotspot).</p>
    <div class="row">
      <input type="text" id="wpsdHost" placeholder="http://192.168.5.82">
      <button id="btnUpdateHost">Update</button>
      <button id="btnTestHost">Test</button>
    </div>
    <div class="msg" id="settingsMsg"></div>
    <div id="hostStatus" class="msg"></div>
  </section>

  <section class="card">
    <h2 class="card-title">TGIF Manager</h2>
    <div class="tg-status" id="tgStatus">Loading…</div>
    <div class="segmented">
      <input type="radio" name="ts" id="ts1" value="1">
      <label for="ts1">TS1</label>
      <input type="radio" name="ts" id="ts2" value="2" checked>
      <label for="ts2">TS2</label>
    </div>
    <div class="row" style="margin-top:var(--space-md)">
      <button class="btn-success" id="btnLink777">Link 777 (Parrot)</button>
      <button id="btnLinkCustom">Link</button>
      <input type="text" id="tgInput" placeholder="TG" maxlength="6" pattern="[0-9]*" inputmode="numeric">
      <button id="btnUnlink">Unlink</button>
    </div>
    <div class="msg" id="tgMsg"></div>
  </section>

  <section class="card">
    <h2 class="card-title">Admin Actions</h2>
    <div class="grid">
      <button id="btnRestartServices">Restart Services</button>
      <button id="btnStopServices">Stop Services</button>
      <button id="btnUpdateWpsd">WPSD Update</button>
      <button id="btnUpdateHostfiles">Update Hostfiles</button>
      <button id="btnReloadWifi">Reload Wi‑Fi</button>
    </div>
    <div class="danger-zone grid">
      <button class="btn-danger" id="btnReboot">Reboot</button>
      <button class="btn-danger" id="btnShutdown">Shutdown</button>
    </div>
    <div class="msg" id="adminMsg"></div>
  </section>

  <section class="card">
    <h2 class="card-title">Last Heard</h2>
    <div id="lastHeard" class="msg">Loading…</div>
    <button id="btnRefreshLH">Refresh</button>
  </section>

  <div id="confirmOverlay" class="modal-overlay" style="display:none">
    <div class="modal">
      <p id="confirmText"></p>
      <div class="btns">
        <button id="confirmCancel">Cancel</button>
        <button class="btn-danger" id="confirmOk">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const API = "/api";
    const tgStatus = document.getElementById("tgStatus");
    const tgMsg = document.getElementById("tgMsg");
    const adminMsg = document.getElementById("adminMsg");
    const tgInput = document.getElementById("tgInput");
    const lastHeard = document.getElementById("lastHeard");
    const confirmOverlay = document.getElementById("confirmOverlay");
    const confirmText = document.getElementById("confirmText");
    const confirmCancel = document.getElementById("confirmCancel");
    const confirmOk = document.getElementById("confirmOk");
    const wpsdHost = document.getElementById("wpsdHost");
    const settingsMsg = document.getElementById("settingsMsg");
    const hostStatus = document.getElementById("hostStatus");

    async function loadConfig() {
      try {
        const c = await api("/config");
        wpsdHost.value = c.wpsdHost || "";
        hostStatus.textContent = c.reachable ? "WPSD reachable" : "WPSD not reachable – check IP and network";
        hostStatus.className = "status-pill " + (c.reachable ? "ok" : "err");
      } catch (e) {
        hostStatus.textContent = "Could not load config";
        hostStatus.className = "status-pill err";
      }
    }

    document.getElementById("btnUpdateHost").onclick = async () => {
      const v = wpsdHost.value.trim();
      if (!v) { settingsMsg.textContent = "Enter a URL (e.g. http://192.168.5.82)"; settingsMsg.className = "msg err"; return; }
      const btn = document.getElementById("btnUpdateHost");
      btn.disabled = true;
      settingsMsg.textContent = "";
      try {
        await api("/config", { method: "PUT", body: JSON.stringify({ wpsdHost: v }) });
        settingsMsg.textContent = "Saved";
        settingsMsg.className = "msg ok";
        await loadConfig();
        refreshTgStatus();
        refreshLastHeard();
      } catch (e) {
        settingsMsg.textContent = e.message;
        settingsMsg.className = "msg err";
      } finally {
        btn.disabled = false;
      }
    };

    document.getElementById("btnTestHost").onclick = () => loadConfig();

    function getTS() {
      const r = document.querySelector('input[name="ts"]:checked');
      return r ? parseInt(r.value, 10) : 2;
    }

    function escapeHtml(str) {
      if (str == null) return "";
      const s = String(str);
      return s
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    const API_TIMEOUT_MS = 15000;

    async function api(path, opts = {}) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), opts.timeout ?? API_TIMEOUT_MS);
      try {
        const res = await fetch(API + path, {
          headers: opts.body ? { "Content-Type": "application/json" } : undefined,
          ...opts,
          signal: ctrl.signal,
        });
        clearTimeout(t);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        return data;
      } catch (e) {
        clearTimeout(t);
        if (e.name === "AbortError") throw new Error("Request timed out");
        throw e;
      }
    }

    async function refreshTgStatus() {
      try {
        const s = await api("/tgif/status");
        const ts1 = s.slot1 ? `TS1: TG${s.slot1}` : "TS1: None";
        const ts2 = s.slot2 ? `TS2: TG${s.slot2}` : "TS2: None";
        tgStatus.innerHTML = `<span>${escapeHtml(ts1)}</span><span>${escapeHtml(ts2)}</span>`;
      } catch (e) {
        tgStatus.textContent = "Offline or TGIF not configured";
      }
    }

    function setTgMsg(txt, ok) {
      tgMsg.textContent = txt;
      tgMsg.className = "msg " + (ok ? "ok" : "err");
    }

    async function linkTg(tg) {
      const ts = getTS();
      try {
        await api("/tgif/link", { method: "POST", body: JSON.stringify({ tg: String(tg), timeslot: ts }) });
        setTgMsg(`Linked TG ${tg} on TS${ts}`, true);
        refreshTgStatus();
      } catch (e) {
        setTgMsg(e.message, false);
      }
    }

    async function unlinkTg() {
      const ts = getTS();
      try {
        await api("/tgif/unlink", { method: "POST", body: JSON.stringify({ timeslot: ts }) });
        setTgMsg(`Unlinked TS${ts}`, true);
        refreshTgStatus();
      } catch (e) {
        setTgMsg(e.message, false);
      }
    }

    document.getElementById("btnLink777").onclick = () => linkTg(777);
    document.getElementById("btnLinkCustom").onclick = () => {
      const v = tgInput.value.trim();
      if (!v) { setTgMsg("Enter a TG number", false); return; }
      linkTg(v);
    };
    document.getElementById("btnUnlink").onclick = unlinkTg;

    function setAdminMsg(txt, ok) {
      adminMsg.textContent = txt;
      adminMsg.className = "msg " + (ok ? "ok" : "err");
    }

    async function wpsdAction(action, btn) {
      if (btn) btn.disabled = true;
      try {
        const r = await api("/wpsd/action", { method: "POST", body: JSON.stringify({ action }) });
        setAdminMsg(JSON.stringify(r), true);
      } catch (e) {
        setAdminMsg(e.message, false);
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    let pendingAction = null;
    let pendingTriggerBtn = null;

    function closeConfirm(confirmed) {
      if (!pendingAction) return;
      const action = pendingAction;
      const btn = pendingTriggerBtn;
      pendingAction = null;
      pendingTriggerBtn = null;
      confirmOverlay.style.display = "none";
      document.removeEventListener("keydown", handleConfirmKeydown);
      if (confirmed) wpsdAction(action, btn);
    }

    function handleConfirmKeydown(e) {
      if (e.key === "Escape") {
        e.preventDefault();
        closeConfirm(false);
      }
    }

    function confirmDanger(title, action, triggerBtn) {
      confirmText.textContent = title;
      pendingAction = action;
      pendingTriggerBtn = triggerBtn || null;
      confirmOverlay.style.display = "flex";
      document.addEventListener("keydown", handleConfirmKeydown);
      confirmCancel.onclick = () => closeConfirm(false);
      confirmOk.onclick = () => closeConfirm(true);
    }

    document.getElementById("btnRestartServices").onclick = (e) => wpsdAction("restart_wpsd_services", e.target);
    document.getElementById("btnStopServices").onclick = (e) => wpsdAction("stop_wpsd_services", e.target);
    document.getElementById("btnUpdateWpsd").onclick = (e) => wpsdAction("update_wpsd", e.target);
    document.getElementById("btnUpdateHostfiles").onclick = (e) => wpsdAction("update_hostfiles", e.target);
    document.getElementById("btnReloadWifi").onclick = (e) => wpsdAction("reload_wifi", e.target);
    document.getElementById("btnReboot").onclick = (e) => confirmDanger("Reboot the hotspot?", "reboot", e.target);
    document.getElementById("btnShutdown").onclick = (e) => confirmDanger("Shutdown the hotspot?", "shutdown", e.target);

    async function refreshLastHeard() {
      try {
        const rows = await api("/wpsd/last-heard?limit=50");
        if (!Array.isArray(rows) || rows.length === 0) {
          lastHeard.innerHTML = '<p class="msg">No recent activity</p>';
          lastHeard.className = "msg";
          return;
        }
        const cols = ["time_utc", "mode", "callsign", "target", "src", "duration", "name"];
        let html = '<div class="table-wrap"><table><thead><tr>';
        cols.forEach(c => { html += `<th>${escapeHtml(c.replace(/_/g, " "))}</th>`; });
        html += "</tr></thead><tbody>";
        rows.forEach(r => {
          html += "<tr>";
          cols.forEach(c => { html += `<td>${escapeHtml(r[c])}</td>`; });
          html += "</tr>";
        });
        html += "</tbody></table></div>";
        lastHeard.innerHTML = html;
        lastHeard.className = "";
      } catch (e) {
        lastHeard.innerHTML = `<p class="msg err">${escapeHtml(e.message)}</p>`;
        lastHeard.className = "";
      }
    }

    document.getElementById("btnRefreshLH").onclick = refreshLastHeard;

    loadConfig();
    refreshTgStatus();
    refreshLastHeard();
    setInterval(refreshTgStatus, 15000);
  </script>
</body>
</html>
